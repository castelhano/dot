{% extends "layout/dot.html" %}
{% load static %}
{% block title %}Agenda{% endblock %}
{% block model %}Core{% endblock %}
{% block model_menu %}{% include "_component/menu/core.html" %}{% endblock%}

<style>
{% block style %} {% endblock %}
</style>

{% block content_fluid %}
<a class="d-none" id="clear" href="{% url 'core_agendas' %}"></a>
<div class="card mt-2">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" data-bs-target="#base" href="#"><i class="fas fa-list"></i></a></li>
            <li class="nav-item"><a class="nav-link" id="back" title="ALT + V" href="{% url 'index' %}"><i class="fas fa-undo"></i></a></li>
        </ul>
    </div>
    <div class="card-body tab-content">
        <h5 class="card-title mb-3">Agenda</h5>
        <div class="tab-pane fade show active" id="base" role="tabpanel">
            <div class="row g-2">
                <div class="col col-lg-4 col-xl-3 col-xxl-2">
                    <div id="calendar_widget"></div>
                </div>
                <div class="col-lg mt-3 mt-lg-2">
                    <div class="row">
                        <div class="col"><h5 class="text-muted" id="title_selected_day"></h5></div>
                        {% if perms.core.add_agenda %}<div class="col-auto pe-4"><a class="btn btn-sm btn-success" href="{% url 'core_agenda_add' %}"><i class="fas fa-plus"></i></a></div>{% endif %}
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover fs-7 user-select-none">
                            <thead>
                                <tr>
                                    <th>Periodo</th>
                                    <th>Titulo</th>
                                    <th>Tags</th>
                                </tr>
                            </thead>
                            <tbody id="day_timeline"></tbody>
                        </table>
                    </div>
                </div>
                <div class="col-lg-3 mt-3 mt-lg-2" id="event_detail"></div>
            </div>                
        </div>
    </div>
</div>
{% endblock%}

{% block add_script_src %}
<script src="{% static 'js/calendar.js' %}"></script>
<script src="{% static 'js/url.js' %}"></script>
{% endblock %}

<script>
{% block add_script %}
let originalDate = urlGetParam('data', today(0,0,0,true));
let year = originalDate.split('-')[0];
let month = originalDate.split('-')[1];

let events = {}
const calendar = new jsCalendar({
    container: document.getElementById('calendar_widget'),
    year: year,
    month: month,
    canChangeView: false,
    canSelectDay: true,
    showSummary: true,
    selectedDays: [originalDate],
    calendarControlsCurrentClasslist: 'btn btn-sm btn-purple-light fs-8 me-1 py-1 py-lg-0',
    calendarControlsSelectDayClasslist: 'btn btn-sm btn-purple-light fs-9'
});

// ***********************
let agendaMes = {};
let title = document.getElementById('title_selected_day');
let tbody = document.getElementById('day_timeline');
let detail = document.getElementById('event_detail');
let translateWeekDay = {0:'DOM', 1:'SEG',2:'TER',3:'QUA',4:'QUI',5:'SEX',6:'SAB'};



function showDayTimeline(day){
    let data = new Date(`${day} 00:00`);
    let [ano, mes, dia] = day.split('-');
    title.innerHTML = `${dia} ${calendar.monthNames[parseInt(mes) - 1]} <span class="text-purple">${translateWeekDay[data.getDay()]}</span> ${ano}`;    
}
showDayTimeline(originalDate);

function showDetails(el, day, id){
    let [ano, mes, dia] = day.split('-');
    let dd = agendaMes[day][id]; // DayDetail
    let participantes = '';
    let anexoFileName = dd?.anexo ? dd.anexo.split('/')[6] : null;
    dd.participantes.split(';').forEach((e) => {participantes += `<span class="badge bg-dark me-1">${e}</span>`;});
    detail.innerHTML = `<small>Criado em: <b>${dia}/${mes}/${ano}</b> - <span>..pendente..</span></small><hr class="m-0">`;
    detail.innerHTML += `<small>Local: <b>${dd.local}</b></small>`;
    detail.innerHTML += `<div class="mt-1">${dd.detalhe}</div>`;
    detail.innerHTML += `<div>${participantes}</div><hr class="mt-2 mb-1">`;
    detail.innerHTML += anexoFileName ? `<a href="/media/${dd.anexo}" target="_blank">${anexoFileName}</a>` : '';
    tbody.querySelectorAll('tr.table-secondary').forEach((e) => {e.classList.remove('table-secondary')});
    el.classList.add('table-secondary');
}



function getAgenda(data) {
    tbody.innerHTML = '';
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        if(this.readyState == 4 && this.status == 200){
            if(this.responseText == ''){}
            else{
                let obj = JSON.parse(this.responseText);
                for(key in obj){
                    if(agendaMes[data] != undefined){agendaMes[data].push(obj[key].fields)}
                    else{agendaMes[data] = [obj[key].fields]}
                    let tags = obj[key].fields.tags.split(';')
                    let tagsEl = '';
                    for(let tag in tags){tagsEl += `<span class="badge bg-purple me-1">${tags[tag]}</span>`}
                    tbody.innerHTML += `<tr class="pointer" onclick="showDetails(this,'${data}','${key}')"><td>${obj[key].fields?.inicio ? obj[key].fields.inicio.slice(0,5) : '--'} a ${obj[key].fields.termino ? obj[key].fields.termino.slice(0,5) : '--'}</td><td>${obj[key].fields.titulo}</td><td>${tagsEl}</td></tr>`;
                }
            }
        }
    };
    xhttp.open("GET", `{% url 'core_get_agenda' %}?data=${data}`, true);
    xhttp.send();
}
getAgenda(originalDate);

{% endblock %}
</script>